<div class="container mx-auto my-8">
    <h1 class="text-3xl font-bold mb-4">Dashboard</h1>

    <div class="flex space-x-4">
        <div class="w-1/3">
            <div class="column" id="to-do" ondrop="drop(event, 'to-do')" ondragover="allowDrop(event)">
                <h2 class="text-xl font-semibold mb-4">To-Do</h2>
                {{#each cards}}
                {{#if (eq column "to-do")}}
                <div class="card" id="{{id}}" draggable="true" ondragstart="drag(event)">
                    <h3 class="text-lg font-semibold">{{title}}</h3>
                    <p>{{description}}</p>
                </div>
                {{/if}}
                {{/each}}
                <!-- Form for creating new cards in 'to-do' column -->
                <form class="create-card-form" data-column="to-do">
                    <input type="text" name="title" placeholder="Title" class="w-full p-2 mb-2 border rounded title" required>
                    <textarea name="description" placeholder="Description" class="w-full p-2 mb-2 border rounded description"
                        required></textarea>
                    <input type="hidden" name="column" value="to-do">
                    <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded">Create Card</button>
                </form>
            </div>
        </div>

        <div class="w-1/3">
            <div class="column" id="in-work" ondrop="drop(event, 'in-work')" ondragover="allowDrop(event)">
                <h2 class="text-xl font-semibold mb-4">In-Work</h2>
                {{#each cards}}
                {{#if (eq column "in-work")}}
                <div class="card" id="{{id}}" draggable="true" ondragstart="drag(event)">
                    <h3 class="text-lg font-semibold">{{title}}</h3>
                    <p>{{description}}</p>
                </div>
                {{/if}}
                {{/each}}
                <!-- Form for creating new cards in 'in-work' column -->
               <!-- <form class="create-card-form" data-column="in-work">
                    <input type="text" name="title" placeholder="Title" class="w-full p-2 mb-2 border rounded" required>
                    <textarea name="description" placeholder="Description" class="w-full p-2 mb-2 border rounded"
                        required></textarea>
                    <input type="hidden" name="column" value="in-work">
                    <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded">Create Card</button>
                </form>-->
            </div>
        </div>

        <div class="w-1/3">
            <div class="column" id="completed" ondrop="drop(event, 'completed')" ondragover="allowDrop(event)">
                <h2 class="text-xl font-semibold mb-4">Completed</h2>
                {{#each cards}}
                {{#if (eq column "completed")}}
                <div class="card" id="{{id}}" draggable="true" ondragstart="drag(event)">
                    <h3 class="text-lg font-semibold">{{title}}</h3>
                    <p>{{description}}</p>
                </div>
                {{/if}}
                {{/each}}
                <!-- Form for creating new cards in 'completed' column -->
                {{!-- <form class="create-card-form" data-column="completed">
                    <input type="text" name="title" placeholder="Title" class="w-full p-2 mb-2 border rounded" required>
                    <textarea name="description" placeholder="Description" class="w-full p-2 mb-2 border rounded"
                        required></textarea>
                    <input type="hidden" name="column" value="completed">
                    <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded">Create Card</button>
                </form> --}}
            </div>
        </div>
    </div>
</div>

<script>
    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        event.dataTransfer.setData('text/plain', event.target.id);
    }

    function drop(event, column) {
        event.preventDefault();
        const cardId = event.dataTransfer.getData('text/plain');
        const cardElement = document.getElementById(cardId);
        const cardColumn = cardElement.parentNode.id;

        console.log('Dropping card:', cardId, 'from column:', cardColumn, 'to column:', column);

        if (cardColumn !== column) {
            // Update the card's column on the server
            fetch(`/dashboard/move-card/${cardId}/${column}`, { method: 'POST' })
                .then(response => {
                    console.log(response);
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status} - ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(createdCard => {
                    console.log('Card created successfully:', createdCard);
                    // Move the card to the new column
                    document.getElementById(column).appendChild(cardElement);
                })
                .catch(error => {
                    console.error('Error creating/moving card:', error);
                    return error.text(); // Add this line to log the response text
                })
                .then(responseText => {
                    console.log('Server response text:', responseText);
                });

        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.create-card-form').forEach(form => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const data = {
                    title: document.querySelector('.title').value,
                    description: document.querySelector('.description').value,
                    status: 'to-do'
                };
                console.log('data', data)
                const column = form.getAttribute('data-column');

                try {
                    // Submit the form data to create a new card
                    const response = await fetch('/dashboard/create-card', {
                        method: 'POST',
                        body: JSON.stringify(data),
                        headers: {
                            'Content-Type':'application/json'
                        }
                    });

                    if (response.ok) {
                        // Card created successfully, update the UI
                        const newCardData = await response.json();
                        const newCardElement = document.createElement('div');
                        newCardElement.classList.add('card');
                        newCardElement.id = newCardData.id;
                        newCardElement.draggable = true;
                        newCardElement.ondragstart = drag;
                        newCardElement.innerHTML = `
                        <h3 class="text-lg font-semibold">${newCardData.title}</h3>
                        <p>${newCardData.description}</p>
                    `;

                        // Append the new card to the appropriate column
                        document.getElementById(column).appendChild(newCardElement);

                        // Clear the form
                        form.reset();
                    } else {
                        console.error('Error creating card:', response.statusText);
                    }
                } catch (error) {
                    console.error('Error creating card:', error);
                }
            });
        });
    });
</script>